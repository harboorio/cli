name: Release

on:
    push:
        branches:
            - main

env:
    CI: 1
    GITHUB_TOKEN: ${{ github.token }}
    PYTHON_VERSION: "3.14"

permissions:
    contents: write # to be able to publish a GitHub release
    issues: write # to be able to comment on released issues
    pull-requests: write # to be able to comment on released pull requests
    id-token: write # to enable use of OIDC for npm provenance
    packages: write

jobs:
    release:
        runs-on: ubuntu-24.04
        steps:
            - uses: actions/checkout@v4
              with:
                fetch-depth: 0

            - name: check commits
              uses: cocogitto/cocogitto-action@v4.1.0
              with:
                command: check

            - name: read current version
              uses: cocogitto/cocogitto-action@v4.1.0
              id: current
              with:
                command: -v get-version
                args: --tag --fallback 0.0.0

            - name: perform a release
              uses: cocogitto/cocogitto-action@v4.1.0
              id: perform
              with:
                command: bump
                args: --auto --skip-ci
                git-user: 'Murat GÃ¶zel'
                git-user-email: 'murat@gozel.com.tr'

            - name: print version
              run: "echo '${{ steps.perform.outputs.version }}'"

            - name: stdout changelog
              if: ${{ steps.current.outputs.stdout != steps.perform.outputs.version && steps.current.outputs.stdout != '0.0.0' }}
              id: changelog
              uses: cocogitto/cocogitto-action@v4.1.0
              with:
                command: changelog
                args: --at ${{ steps.perform.outputs.version }}

            - name: create github release
              if: ${{ steps.current.outputs.stdout != steps.perform.outputs.version && steps.current.outputs.stdout != '0.0.0' }}
              uses: softprops/action-gh-release@v2
              with:
                body: ${{ steps.changelog.outputs.stdout }}
                tag_name: ${{ steps.perform.outputs.version }}
